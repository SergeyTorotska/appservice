{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "webAppName": {
            "defaultValue": "myWebApp",
            "type": "string"
        },
        "virtualNetworkName": {
            "defaultValue": "myVirtualNetwork",
            "type": "string"
        },
        "appGatewaySubnetName": {
            "defaultValue": "myAppGatewaySubnet",
            "type": "string"
        },
        "appGatewayName": {
            "defaultValue": "myAppGateway",
            "type": "string"
        },
        "location": {
            "defaultValue": "[resourceGroup().location]",
            "type": "string"
        },
      "sslCertificatePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for .pfx certificate"
      }
    },"capacity": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Number of instances"
      }
    }
    },
    "variables": {
        "location": "[parameters('location')]",
        "virtualNetworkName": "[concat(parameters('virtualNetworkName'), '-', uniqueString(resourceGroup().id))]",
        "virtualNetworkAddressPrefix": "10.0.0.0/20",
        "virtualNetworkSubnetName": "[parameters('appGatewaySubnetName')]",
        "virtualNetworkSubnetPrefix": "10.0.0.0/24",
        "virtualNetworkId": "[resourceId('Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
        "virtualNetworkSubnetId": "[resourceId('Microsoft.Network/virtualNetworks/subnets/', variables('virtualNetworkName'), variables('virtualNetworkSubnetName'))]",
        "publicIpAddressName": "[concat('myAppGatewayPublicIp', '-', uniqueString(resourceGroup().id))]",
        "publicIpAddressSku": "Standard",
        "publicIpAddressAllocationType": "Static",
        "publicIpAddressId": "[resourceId('Microsoft.Network/publicIPAddresses/', variables('publicIpAddressName'))]",
        "webAppName": "[concat(parameters('webAppName'), '-', uniqueString(resourceGroup().id))]",
        "webAppPlanName": "[concat(parameters('webAppName'), 'Plan', '-', uniqueString(resourceGroup().id))]",
        "webAppPlanSku": "B1",
        "webAppPlanId": "[resourceId('Microsoft.Web/serverfarms', variables('webAppPlanName'))]",
        "applicationGatewayName": "[concat(parameters('appGatewayName'), '-', uniqueString(resourceGroup().id))]",
        "applicationGatewaySkuSize": "Standard_v2",
        "applicationGatewayTier": "Standard_v2",
        "appGwIpConfigName": "appGatewayIpConfigName",
        "appGwFrontendPortName": "appGatewayFrontendPort",
        "appGwFrontendPort": 443,
        "appGwFrontendPortId": "[resourceId('Microsoft.Network/applicationGateways/frontendPorts/', variables('applicationGatewayName'), variables('appGwFrontendPortName'))]",
        "appGwFrontendIpConfigName": "appGatewayPublicFrontendIpConfig",
        "appGwFrontendIpConfigId": "[resourceId('Microsoft.Network/applicationGateways/frontendIPConfigurations/', variables('applicationGatewayName'), variables('appGwFrontendIpConfigName'))]",
        "appGwHttpSettingName": "appGatewayHttpSetting",
        "appGwHttpSettingId": "[resourceId('Microsoft.Network/applicationGateways/backendHttpSettingsCollection/', variables('applicationGatewayName'), variables('appGwHttpSettingName'))]",
        "appGwHttpSettingProbeName": "appGatewayHttpSettingProbe",
        "appGwBackendAddressPoolName": "[concat('appGateway', variables('webAppName'), 'BackendPool')]",
        "appGwBackendAddressPoolId": "[resourceId('Microsoft.Network/applicationGateways/backendAddressPools/', variables('applicationGatewayName'), variables('appGwBackendAddressPoolName'))]",
        "appGwListenerName": "appGatewayListener",
        "appGwListenerId": "[resourceId('Microsoft.Network/applicationGateways/httpListeners/', variables('applicationGatewayName'), variables('appGwListenerName'))]",
        "appGwRoutingRuleName": "appGatewayRoutingRule"
    },
    "resources": [
        {
            "type": "Microsoft.Network/virtualNetworks",
            "apiVersion": "2020-05-01",
            "name": "[variables('virtualNetworkName')]",
            "location": "[variables('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('virtualNetworkAddressPrefix')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('virtualNetworkSubnetName')]",
                        "properties": {
                            "addressPrefix": "[variables('virtualNetworkSubnetPrefix')]",
                            "serviceEndpoints": [
                                {
                                    "service": "Microsoft.Web",
                                    "locations": [
                                        "*"
                                    ]
                                }
                            ]
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Web/serverfarms",
            "name": "[variables('webAppPlanName')]",
            "apiVersion": "2021-01-01",
            "location": "[variables('location')]",
            "properties": {
                "reserved": "false"
            },
            "sku": {
                "name": "[variables('webAppPlanSku')]",
                "capacity": 1
            }
        },
        {
            "name": "[variables('webAppName')]",
            "type": "Microsoft.Web/sites",
            "apiVersion": "2021-01-01",
            "location": "[variables('location')]",
            "dependsOn": [
                "[variables('webAppPlanId')]",
                "[variables('virtualNetworkId')]"
            ],
            "properties": {
                "serverFarmId": "[variables('webAppPlanId')]",
                "reserved": "false",
                "siteConfig": {
                    "http20Enabled": "true",
                    "minTlsVersion": "1.2",
                    "ipSecurityRestrictions": [
                        {
                            
                        }
                    ]
                },
                "httpsOnly": "true"
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "apiVersion": "2020-05-01",
            "name": "[variables('publicIpAddressName')]",
            "location": "[variables('location')]",
            "sku": {
                "name": "[variables('publicIpAddressSku')]"
            },
            "properties": {
                "publicIPAllocationMethod": "[variables('publicIpAddressAllocationType')]",
                "dnsSettings": {
                    "domainNameLabel": "[toLower(variables('webAppName'))]"
                }
            }
        },
        {
            "type": "Microsoft.Network/applicationGateways",
            "apiVersion": "2020-05-01",
            "name": "[variables('applicationGatewayName')]",
            "location": "[variables('location')]",
            "dependsOn": [
                "[variables('publicIpAddressId')]",
                "[variables('virtualNetworkId')]"
            ],
            "properties": {
                "sku": {
                    "name": "[variables('applicationGatewaySkuSize')]",
                    "tier": "[variables('applicationGatewayTier')]",
                    "capacity": "[parameters('capacity')]"
                },
                "gatewayIPConfigurations": [
                    {
                        "name": "[variables('appGwIpConfigName')]",
                        "properties": {
                            "subnet": {
                                "id": "[variables('virtualNetworkSubnetId')]"
                            }
                        }
                    }
                ],
                "frontendIPConfigurations": [
                    {
                        "name": "[variables('appGwFrontendIpConfigName')]",
                        "properties": {
                            "PublicIPAddress": {
                                "id": "[variables('publicIpAddressId')]"
                            }
                        }
                    }
                ],
                "frontendPorts": [
                    {
                        "name": "[variables('appGwFrontendPortName')]",
                        "properties": {
                            "Port": "[variables('appGwFrontendPort')]"
                        }
                    }
                ],
                "backendAddressPools": [
                    {
                        "name": "[variables('appGwBackendAddressPoolName')]",
                        "properties": {
                            "backendAddresses": [
                                {
                                   "ipAddress": "54.34.53.663"
                                }
                            ]
                        }
                    }
                ],
                "backendHttpSettingsCollection": [
                    {
                        "name": "[variables('appGwHttpSettingName')]",
                        "properties": {
                            "Port": 443,
                            "Protocol": "Https",
                            "cookieBasedAffinity": "Disabled",
                            "requestTimeout": 10
                           
                        }
                    }
                ],
                "httpListeners": [
                    {
                        "name": "[variables('appGwListenerName')]",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[variables('appGwFrontendIpConfigId')]"
                            },
                            "frontendPort": {
                                "id": "[variables('appGwFrontendPortId')]"
                            },
                            "protocol": "Https",
                            "SslCertificate": {
                            "Id": "[resourceId('Microsoft.Network/applicationGateways/sslCertificates',variables('applicationGatewayName'), 'appGatewaySslCert')]"
              }
                        }
                    }
                ],
                "requestRoutingRules": [
                    {
                        "Name": "[variables('appGwRoutingRuleName')]",
                        "properties": {
                            "RuleType": "Basic",
                            "httpListener": {
                                "id": "[variables('appGwListenerId')]"
                            },
                            "backendAddressPool": {
                                "id": "[variables('appGwBackendAddressPoolId')]"
                            },
                            "backendHttpSettings": {
                                "id": "[variables('appGwHttpSettingId')]"
                            }
                        }
                    }
                ],
                "enableHttp2": false,
                "sslCertificates": [
{
            "name": "appGatewaySslCert",
            "properties": {
              "data": "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",
              "password": "[parameters('sslCertificatePassword')]"
            }
          }

                
                ]              
            }
        }
    ],
    "outputs": {}
    
}
